<%= form_with(model: credential, local: true, class: "space-y-6") do |form| %>
  <!-- Error Messages -->
  <% if credential.errors.any? %>
    <div class="rounded-lg bg-red-50 border border-red-200 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(credential.errors.count, "error") %> prohibited this credential from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% credential.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Title Field -->
  <div>
    <%= form.label :title, class: "block text-sm font-medium text-gray-700 mb-1" do %>
      Title <span class="text-red-500">*</span>
    <% end %>
    <%= form.text_field :title,
      placeholder: "e.g., Medical License, Insurance Card, Vaccination Record",
      class: "mt-1 block w-full px-4 py-3 border #{credential.errors[:title].any? ? 'border-red-300' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-150",
      required: true,
      autofocus: true %>
    <% if credential.errors[:title].any? %>
      <p class="mt-1 text-sm text-red-600"><%= credential.errors[:title].first %></p>
    <% end %>
  </div>

  <!-- Date Fields Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Start Date Field -->
    <div>
      <%= form.label :start_date, "Issue Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.date_field :start_date,
        class: "mt-1 block w-full px-4 py-3 border #{credential.errors[:start_date].any? ? 'border-red-300' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-150" %>
      <p class="mt-1 text-xs text-gray-500">When was this credential issued?</p>
      <% if credential.errors[:start_date].any? %>
        <p class="mt-1 text-sm text-red-600"><%= credential.errors[:start_date].first %></p>
      <% end %>
    </div>

    <!-- End Date Field -->
    <div>
      <%= form.label :end_date, "Expiration Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= form.date_field :end_date,
        class: "mt-1 block w-full px-4 py-3 border #{credential.errors[:end_date].any? ? 'border-red-300' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-150" %>
      <p class="mt-1 text-xs text-gray-500">When does this credential expire?</p>
      <% if credential.errors[:end_date].any? %>
        <p class="mt-1 text-sm text-red-600"><%= credential.errors[:end_date].first %></p>
      <% end %>
    </div>
  </div>

  <!-- Notes Field -->
  <div>
    <%= form.label :notes, class: "block text-sm font-medium text-gray-700 mb-1" do %>
      Notes
    <% end %>
    <%= form.text_area :notes,
      rows: 4,
      placeholder: "Add any additional information about this credential...",
      class: "mt-1 block w-full px-4 py-3 border #{credential.errors[:notes].any? ? 'border-red-300' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-colors duration-150 resize-none" %>
    <p class="mt-1 text-xs text-gray-500">Optional: Provider name, policy number, or other relevant details</p>
    <% if credential.errors[:notes].any? %>
      <p class="mt-1 text-sm text-red-600"><%= credential.errors[:notes].first %></p>
    <% end %>
  </div>

  <!-- File Upload Field -->
  <div>
    <%= form.label :file, class: "block text-sm font-medium text-gray-700 mb-1" do %>
      Upload File <%= content_tag(:span, "*", class: "text-red-500") unless credential.persisted? %>
    <% end %>

    <% if credential.file.attached? %>
      <!-- Current File Display -->
      <div class="mb-3 p-4 bg-gray-50 border border-gray-200 rounded-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <svg class="h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
            <div>
              <p class="text-sm font-medium text-gray-900"><%= credential.file.filename %></p>
              <p class="text-xs text-gray-500"><%= number_to_human_size(credential.file.byte_size) %></p>
            </div>
          </div>
          <div class="flex items-center space-x-2">
            <%= link_to rails_blob_path(credential.file), target: "_blank", class: "text-purple-600 hover:text-purple-900 transition-colors duration-150" do %>
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            <% end %>
          </div>
        </div>
      </div>
      <p class="mb-2 text-sm text-gray-600">Upload a new file to replace the current one:</p>
    <% end %>

    <!-- File Input -->
    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 #{credential.errors[:file].any? ? 'border-red-300' : 'border-gray-300'} border-dashed rounded-lg hover:border-purple-400 transition-colors duration-150">
      <div class="space-y-1 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
          <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div class="flex text-sm text-gray-600">
          <label for="credential_file" class="relative cursor-pointer bg-white rounded-md font-medium text-purple-600 hover:text-purple-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-purple-500 transition-colors duration-150">
            <span>Upload a file</span>
            <%= form.file_field :file,
              id: "credential_file",
              class: "sr-only",
              accept: "image/*,.pdf,.doc,.docx",
              required: !credential.persisted?,
              onchange: "displayFileName(this)" %>
          </label>
          <p class="pl-1">or drag and drop</p>
        </div>
        <p class="text-xs text-gray-500">PNG, JPG, PDF, DOC up to 10MB</p>
        <p id="file-name" class="text-sm font-medium text-gray-900 mt-2"></p>
      </div>
    </div>
    <% if credential.errors[:file].any? %>
      <p class="mt-1 text-sm text-red-600"><%= credential.errors[:file].first %></p>
    <% end %>
  </div>

  <!-- Form Actions -->
  <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
    <%= link_to credential.persisted? ? credential_path(credential) : credentials_path,
      class: "px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-150" do %>
      Cancel
    <% end %>
    <%= form.submit credential.persisted? ? "Update Credential" : "Create Credential",
      class: "px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-all duration-200 cursor-pointer" %>
  </div>
<% end %>

<script>
  function displayFileName(input) {
    const fileNameDisplay = document.getElementById('file-name');
    if (input.files && input.files[0]) {
      fileNameDisplay.textContent = input.files[0].name;
    } else {
      fileNameDisplay.textContent = '';
    }
  }

  // Drag and drop functionality
  const dropZone = document.querySelector('[class*="border-dashed"]');

  if (dropZone) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
      dropZone.classList.add('border-purple-500', 'bg-purple-50');
    }

    function unhighlight(e) {
      dropZone.classList.remove('border-purple-500', 'bg-purple-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      const fileInput = document.getElementById('credential_file');

      if (fileInput && files.length > 0) {
        fileInput.files = files;
        displayFileName(fileInput);
      }
    }
  }
</script>
